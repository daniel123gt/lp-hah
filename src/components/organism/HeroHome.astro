---
// HeroHome.astro
---

<section class="w-full h-[400px] sm:h-[500px] md:h-[600px] lg:h-[800px] overflow-hidden relative">
  <video
    autoplay
    muted
    loop
    playsinline
    id="myVideo"
    class="w-full h-full object-cover"
    preload="none"
    poster="/src/assets/images/hero/hero1.webp"
  >
    <source src="video/presentacion.mp4" type="video/mp4" />
    Tu navegador no soporta video HTML5.
  </video>

  <!-- Fallback/Loading state -->
  <div
    class="absolute inset-0 bg-gray-200 flex items-center justify-center"
    id="video-fallback"
  >
    <div class="text-center px-4">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-blue mx-auto mb-4"></div>
      <p class="text-gray-600 text-sm sm:text-base">Cargando video...</p>
    </div>
  </div>
</section>

<script>
  let observer: IntersectionObserver | null = null;
  let video: HTMLVideoElement | null = null;
  let fallback: HTMLElement | null = null;

  function initializeVideo() {
    video = document.getElementById("myVideo") as HTMLVideoElement;
    fallback = document.getElementById("video-fallback");

    if (!video || !fallback) return;

    // Limpiar observer anterior si existe
    if (observer) {
      observer.disconnect();
    }

    // Crear nuevo observer
    observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          // Solo cargar si no se ha cargado ya
          if (video && video.readyState === 0) {
            video.preload = "metadata";
            video.load();
          }
        }
      });
    }, {
      threshold: 0.1 // Activar cuando 10% del video sea visible
    });
    
    observer.observe(video);

    // Event listeners
    video.addEventListener("loadeddata", () => {
      if (fallback) {
        fallback.style.display = "none";
      }
    });

    video.addEventListener("error", () => {
      console.error("Error al cargar el video");
      if (fallback) {
        fallback.innerHTML = '<div class="text-center px-4"><p class="text-red-600 text-sm sm:text-base">Error al cargar el video</p></div>';
      }
    });

    // Forzar reproducción en caso de que autoplay falle
    video.play().catch((error) => {
      console.warn("Autoplay bloqueado:", error);
    });
  }

  // Inicializar cuando la página carga
  document.addEventListener("DOMContentLoaded", initializeVideo);

  // Para navegación SPA de Astro
  document.addEventListener("astro:page-load", initializeVideo);

  // Cleanup cuando se desmonta
  document.addEventListener("astro:before-preparation", () => {
    if (observer) {
      observer.disconnect();
      observer = null;
    }
  });
</script>
